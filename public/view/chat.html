<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="card p-4 shadow">

        <div class="d-flex justify-content-between">
            <h4>Chat Application</h4>
            <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
        </div>

        <hr>

        <!-- Room Selection -->
        <div id="roomSection">
            <h5>Select a Room</h5>

            <select id="roomSelect" class="form-select mb-3">
                <option value="devops">DevOps</option>
                <option value="cloud computing">Cloud Computing</option>
                <option value="covid19">Covid19</option>
                <option value="sports">Sports</option>
                <option value="nodeJS">NodeJS</option>
            </select>

            <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" style="display:none;">
            <h5 id="roomTitle"></h5>
            <button id="leaveRoomBtn" class="btn btn-warning btn-sm mb-2">Leave Room</button>

            <div id="messages" class="border p-3 mb-3" style="height:300px; overflow-y:scroll;"></div>

            <input type="text" id="messageInput" class="form-control mb-2" placeholder="Type message...">
            <button id="sendBtn" class="btn btn-success">Send</button>

            <div id="typingIndicator" class="text-muted mt-2"></div>
        </div>

    </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();

// Check login
const user = JSON.parse(localStorage.getItem("user"));
if (!user) {
    window.location.href = "login.html";
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("user");
    window.location.href = "login.html";
});

let currentRoom = null;

// Join Room
document.getElementById("joinRoomBtn").addEventListener("click", () => {
    currentRoom = document.getElementById("roomSelect").value;

    socket.emit("joinRoom", {
        username: user.username,
        room: currentRoom
    });

    document.getElementById("roomTitle").innerText = "Room: " + currentRoom;
    document.getElementById("roomSection").style.display = "none";
    document.getElementById("chatSection").style.display = "block";
});

// Leave Room
document.getElementById("leaveRoomBtn").addEventListener("click", () => {
    socket.emit("leaveRoom", currentRoom);

    currentRoom = null;
    document.getElementById("chatSection").style.display = "none";
    document.getElementById("roomSection").style.display = "block";
});

// Send Message
document.getElementById("sendBtn").addEventListener("click", () => {
    const message = document.getElementById("messageInput").value;

    if (message && currentRoom) {
        socket.emit("chatMessage", {
            room: currentRoom,
            username: user.username,
            message: message
        });

        document.getElementById("messageInput").value = "";
    }
});

// Receive Message
socket.on("message", (data) => {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML += `<p><strong>${data.username}:</strong> ${data.message}</p>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

socket.on("previousMessages", (messages) => {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    messages.forEach(msg => {
        messagesDiv.innerHTML += `<p><strong>${msg.from_user}:</strong> ${msg.message}</p>`;
    });
});

document.getElementById("messageInput").addEventListener("input", () => {
    socket.emit("typing", {
        room: currentRoom,
        username: user.username
    });
});

socket.on("typing", (username) => {
    document.getElementById("typingIndicator").innerText = username + " is typing...";

    setTimeout(() => {
        document.getElementById("typingIndicator").innerText = "";
    }, 2000);
});

document.getElementById("logoutBtn").addEventListener("click", () => {
    socket.disconnect();
    localStorage.removeItem("user");
    window.location.href = "login.html";
});



</script>
</body>
</html>
